@implements IAsyncDisposable
@inject NavigationManager NavigationManager
@inject LandingService LandingService
@inject LandingServiceUpkeep LandingServiceUpkeep

@code {

    [CascadingParameter]
    protected PageInfo? PageInfo { get; set; }

    private IDisposable? _navChange;
    private bool _isDrawerOpen;
    private bool _isPrint;
    private string _accountName = "Guest";
    private HashSet<AccountRole> _roles = new();

    protected override void OnInitialized()
    {
        _isPrint = NavigationManager.IsPrintPage();
        _navChange = NavigationManager.RegisterLocationChangingHandler(context =>
        {
            _isPrint = context.TargetLocation.EndsWith("/print");
            _isDrawerOpen = false;
            StateHasChanged();
            return ValueTask.CompletedTask;
        });

        LandingServiceOnAuthenticatedChanged(LandingService, EventArgs.Empty);
        LandingService.AuthenticatedChanged += LandingServiceOnAuthenticatedChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        await LandingServiceUpkeep.StartAsync(default);
        await LandingService.ValidateSession();
        var account = await LandingService.GetAccount();
        _roles = account?.Roles?.ToHashSet() ?? new HashSet<AccountRole>();
    }

    public async ValueTask DisposeAsync()
    {
        await LandingServiceUpkeep.StopAsync(default);
        LandingService.AuthenticatedChanged -= LandingServiceOnAuthenticatedChanged;
        _navChange?.Dispose();
    }

    private void LandingServiceOnAuthenticatedChanged(object? sender, EventArgs e)
    {
        _accountName = LandingService.IsAuthenticated
            ? (LandingService.Account?.Name ?? "Name Not Set") 
            : "Guest";
        _roles = LandingService.Account?.Roles.ToHashSet() ?? new HashSet<AccountRole>();
        StateHasChanged();
    }

    private void DrawerToggle()
    {
        _isDrawerOpen = !_isDrawerOpen;
        StateHasChanged();
    }

    private void AccountClick()
    {
        NavigationManager.NavigateTo(LandingService.IsAuthenticated ? "/profile" : "/login");
    }

}

@if (!_isPrint)
{
    <MudAppBar Color="Color.Primary" Fixed="false" Dense="true">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="DrawerToggle"/>
        <MudText>@PageInfo?.HeaderText</MudText>
        <MudSpacer/>
        <MudIconButton Icon="@Icons.Material.Filled.AccountCircle" Color="Color.Inherit" OnClick="AccountClick"/>
    </MudAppBar>
    <MudDrawer @bind-Open="@_isDrawerOpen">
        <MudNavMenu>
            @if (LandingService.IsAuthenticated)
            {
                <MudNavLink Href="/profile" Match="@NavLinkMatch.All" IconColor="@Color.Primary" Icon="@Icons.Material.Filled.AccountCircle">
                    <MudText Typo="@Typo.body1">@_accountName</MudText>
                    <MudText Typo="@Typo.body2" Class="mud-secondary-text">Click to update your profile</MudText>
                </MudNavLink>
            }
            else
            {
                <MudNavLink Href="/login" Match="@NavLinkMatch.All" Icon="@Icons.Material.Filled.AccountCircle">
                    <MudText Typo="@Typo.body1">Guest</MudText>
                    <MudText Typo="@Typo.body2" Class="mud-secondary-text">Click to log in</MudText>
                </MudNavLink>
            }
            <MudDivider/>
            <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">Home</MudNavLink>
            @if (LandingService.IsAuthenticated)
            {
                <MudNavLink Href="/characters" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.People">Characters</MudNavLink>
            }
            <MudNavLink Href="/events" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Event">Events</MudNavLink>
           @if (LandingService.IsAuthenticated)
            {
                <MudNavLink Href="/events/attendance" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.EmojiPeople">Attendance</MudNavLink>
            }
            <MudNavLink Href="/clarify" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Book">Clarify</MudNavLink>
            @if (LandingService.IsAuthenticated)
            {
                <MudDivider/>
                <MudNavLink Href="/profile" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Person">Profile</MudNavLink>
                @if (_roles.Contains(AccountRole.AdminAccess))
                {
                    <MudNavLink Href="/admin" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Shield">Administration</MudNavLink>
                }
            }
        </MudNavMenu>
    </MudDrawer>
}
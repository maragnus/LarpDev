@page "/events"
@inject LandingService LandingService

<PageHeader>Upcoming Events</PageHeader>

<MudContainer MaxWidth="MaxWidth.Large">
    <MudText Typo="Typo.h6" Class="mt-4 mb-4">Upcoming Events</MudText>
    <MudDataGrid T="EventInfo" Items="_events" Filterable Groupable Hover Loading="_isLoading" GroupExpanded="true">
        <ChildRowContent>
            <MudDataGrid T="ComponentInfo" Items="context.Item.Components" Dense SortMode="SortMode.None" Loading="_isLoading">
                <Columns>
                    <PropertyColumn Property="x => x.When" Title="Date" Format="dddd, MMM d, yyyy"/>
                    <PropertyColumn Property="x => x.Title" Title="Title"/>
                </Columns>
            </MudDataGrid>
        </ChildRowContent>
        <Columns>
            <HierarchyColumn T="EventInfo" ButtonDisabledFunc="@(x => x.Components.Length == 0)"/>
            @* <PropertyColumn Property="x => x.Game" Title="Game" Grouping="true"/> *@
            <PropertyColumn Property="x => x.When" Title="Date" Format="dddd, MMM d, yyyy" Groupable="false"/>
            <PropertyColumn Property="x => x.Title" Title="Title" Groupable="false"/>
            <PropertyColumn Property="x => x.Location" Title="Location"/>
        </Columns>
    </MudDataGrid>
</MudContainer>

@code {
    bool _isLoading = true;
    private EventInfo[] _events = Array.Empty<EventInfo>();

    record ComponentInfo(string Title, DateOnly When);

    record EventInfo(string Game, string Title, string Location, DateOnly When, ComponentInfo[] Components)
    {
        public EventInfo(string game, Event e) : this(game, e.Title ?? "Untitled", e.Location ?? "", DateOnly.FromDateTime(e.Date.LocalDateTime),
            e.Components
                .Select(c =>
                    new ComponentInfo(c.Name ?? "Untitled", DateOnly.FromDateTime(c.Date.LocalDateTime)))
                .ToArray())
        {
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var games = LandingService.Games
            .ToDictionary(x => x.Value.Id, x => x.Value.Title);

        string GameName(string gameId) =>
            games.TryGetValue(gameId, out var game) ? game ?? "" : "";

        _events = (await LandingService.GetEvents())
            .Select(x => new EventInfo(GameName(x.GameId), x)).ToArray();
        _isLoading = false;
    }

}